<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ACAMOPRJCT | CHECKOUT</title>
<!-- Bootstrap -->
<link href="https://acamoprjct-dev.s3.us-west-2.amazonaws.com/web/css/bootstrap-4.4.1.css" rel="stylesheet">
<link href="https://acamoprjct-dev.s3.us-west-2.amazonaws.com/web/css/site_styles.css" rel="stylesheet" type="text/css">
</head>

<body id="main" onload="getShippingRates()">
<div class="main">
    <!----- INSERT CONTENT BELOW ----->
    <div class="div-content bg-od-green-fade-2 checkout-content">
      <div class="checkout-col-33 bg-od-green-fade-2">
        <div class="div-cart-summary bg-od-green-fade-2">
          <div class="accordion-items" id="accordion1" role="tablist">
            <div class="card">
              <div class="card-header bg-off-white" role="tab" id="headingOne1">
                <h5 class="mb-0 text-link"><a data-toggle="collapse" href="#collapseOne1" role="button" aria-expanded="true" aria-controls="collapseOne1">
                  <button class="text-dark-grey btn-checkout-cart-items" onclick="viewCartAtCheckout()">CartItems</button>
                  </a>
                </h5>
              </div>
              <div id="collapseOne1" class="collapse" role="tabpanel" aria-labelledby="headingOne1" data-parent="#accordion1">
                <div id="cart-items" style="padding: 2%;"> 
                  <!----- viewCartAtCheckout() -----> 
                  
                </div>
              </div>
            </div>
            <div>
              <hr>
              <h5 id="cart-subtotal" class="text-white"></h5>
              <h5 id="cart-shipping" class="text-white"></h5>
              <h5 id="cart-tax" class="text-white"></h5>
              <hr>
              <h5 id="cart-total" class="text-white"></h5>
              <br>
            </div>
          </div>
        </div>
      </div>
      <div class="checkout-col-66 bg-off-white">
        <div class="div-shipping-form">
          <h1 class="text-dark-grey">ACamoPRJCT</h1>
          <div>
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="https://vv8bvqolr5.execute-api.us-west-2.amazonaws.com/Dev/store/checkout">Summary</a></li>
                <li class="breadcrumb-item"><a href="https://vv8bvqolr5.execute-api.us-west-2.amazonaws.com/Dev/store/checkout/shipping">Shipping</a></li>
                <li class="breadcrumb-item active" aria-current="page">Payment</li>
              </ol>
            </nav>
          </div>
          <br>
          <br>
          <h3>Shipping Options</h3>
          <form class="shipping-form" id="rate-form">
            <ul class="list-shipping-options" id="shipping-options">
                <div class="form-group form-input-1-col">
                    <input type="email" class="form-control" id="email" placeholder="Email" name="email" disabled>
                    <small id="emailHelp1" class="form-text text-muted">We'll never share your email with anyone else. </small>
                  </div>
                <div class="div-spinner" id="spinner">
                  <div class="spinner-border loading-spinner" role="status"> <span class="sr-only">Loading Rates...</span> </div>
                </div>
              <!---- getShippingRates() ----->
        
            </ul>
          </form>
        </div>
        <div class="div-checkout">
          <div class="div-btn-checkout">
            <button type="button" class="btn btn-lg bg-acp-green text-white btn-checkout" onclick="submitRateForm()">Continue to Payment</button>
          </div>
          <br>
          <br>
          <div>
            <a href="" class="continue-shopping-link"><span>Return to Cart</span></a>
            <br>
            <br>
          </div>
        </div>
        <div class="other-info">
          <hr>
          <h4>Other Info</h4>
          <h6>Contact Us</h6>
          <h6>Privacy Policy</h6>
          <h6>Returns and Exchanges</h6>
        </div>
      </div>
    </div>
  <!----- INSERT CONTENT ABOVE ----->
  <footer class="footer">
    <div class="div-footer-content">
      <div class="div-footer-favicons">
        <div class="div-footer-img"><a href="https://instagram.com/acamoprjct/"><img class="img-home" src="https://acamoprjct-dev.s3.us-west-2.amazonaws.com/web/assets/ig-icon-main.png" width="620" height="620" alt=""/></a></div>
        <div class="div-footer-img"><a href="https://twitter.com/acamoprjct/"><img class="img-home" src="https://acamoprjct-dev.s3.us-west-2.amazonaws.com/web/assets/favicons/twitter.png" width="620" height="620" alt=""/></a></div>
        <div class="div-footer-img"><a href="https://discord.gg/HsUdQjGwQ3/"><img class="img-home" src="https://acamoprjct-dev.s3.us-west-2.amazonaws.com/web/assets/favicons/discord-2.png" width="620" height="620" alt=""/></a></div>
        <div class="div-footer-img"><a href="https://m.youtube.com/channel/UCOiuXQ8fAEnac1fykAJt5qA"><img class="img-home" src="https://acamoprjct-dev.s3.us-west-2.amazonaws.com/web/assets/favicons/youtube-main.png" width="620" height="620" alt=""/></a></div>
      </div>
      <div class="div-footer-text">
        <p class="footer-text">&#169; 2021 ACamoPRJCT STUDIOS</p>
      </div>
    </div>
  </footer>
</div>

<!-- The Modal -->
<div id="myModal" class="modal"> 
  
  <!-- Modal content -->
  <div class="modal-content" id="modal-content"> <span class="close" style="font-family: sans-serif;">&times;</span>
    <h2 class="modal-header" id="modal-header">Oh no! Something went wrong :(</h2>
    <p id="modal-text">Please try again and contact our Customer Support at acamodev@acamoprjct.com if the issue is not resolved.</p>
  </div>
</div>

  
<!-- jQuery (necessary for Bootstrap's JavaScript plugins) --> 
<script src="https://acamoprjct-dev.s3.us-west-2.amazonaws.com/web/js/jquery-3.4.1.min.js"></script> 

<!-- Include all compiled plugins (below), or include individual files as needed --> 
<script src="https://acamoprjct-dev.s3.us-west-2.amazonaws.com/web/js/popper.min.js"></script> 
<script src="https://acamoprjct-dev.s3.us-west-2.amazonaws.com/web/js/bootstrap-4.4.1.js"></script> 
<script src="https://acamoprjct-dev.s3.us-west-2.amazonaws.com/web/js/dist/lib.js"></script> 
<script type="text/JavaScript">

  const Endpoint = "https://vv8bvqolr5.execute-api.us-west-2.amazonaws.com/Dev"
  const DevEndpoint = 'http://127.0.0.1:3000'

  function getPricing() {
    let cartJson = localStorage.getItem('cart');
    let cart = JSON.parse(cartJson);

    let subtotal = cart.subtotal;
    let tax = cart.subtotal * 0.0725;
    let total = subtotal + tax;

    let pricing = {
        subtotal: subtotal,
        tax: tax,
        shipping: 0.00,
        total: total,
    }

    sessionStorage.setItem('pricing', JSON.stringify(pricing));

    document.querySelector('#cart-subtotal').innerHTML = 'Subtotal: $' + subtotal.toFixed(2);
    document.querySelector('#cart-shipping').innerHTML = 'Shipping: $0.00';
    document.querySelector('#cart-tax').innerHTML = 'Sales Tax: $' + tax.toFixed(2);
    document.querySelector('#cart-total').innerHTML = 'Total: $' + total.toFixed(2);
    return 
  }

  function updatePricing(priceId) {
    let ss = document.querySelector('#cart-subtotal').innerHTML.split('$')[1];
    let st = document.querySelector('#cart-tax').innerHTML.split('$')[1];
    let sp = document.querySelector(priceId).innerHTML.split('$')[1];

    let subtotal = parseFloat(ss);
    let tax = parseFloat(st)
    let shipPrice = parseFloat(sp);

    let total = subtotal + shipPrice + tax;

    document.querySelector('#cart-shipping').innerHTML = 'Shipping: $' + shipPrice.toFixed(2);
    document.querySelector('#cart-total').innerHTML = 'Total: $' + total.toFixed(2);

    return
  }
  
  function getShippingRates() {
    // get initial pricing
    getPricing();
    // get customer for active order
    let custStr = sessionStorage.getItem('cust');
    if (custStr == "" || custStr == null) {
      // no active order; return to store page
      // use case: user visits shipping page URL directly,
      // bypassing order creation step
      console.log("no customer found")
      // return window.location.replace(Endpoint + "/store")
      return
    }
  
    let cust = JSON.parse(custStr);
    let input = {
        user_id: cust.user_id,
        order_id: cust.order_id,
    }

    document.querySelector('#email').value = cust.user_email;
  
    console.log(input);

    // make db put call
    let putEndpoint = Endpoint + '/store/checkout/get_rates';
    try {
      putTextData(putEndpoint, input)
      .then((response) => {
        console.log(response);
        console.log(response.message)
        console.log(response.body);
        return createShippingOptions(response.body)
      })
      .catch((err) => {
        console.log('err: ' + err)
        return showErrModal(err);
      })
      
    } catch (error) {
      console.log('err: ' + error);
      return showErrModal(error);
    }
  }
  
  // createShippingOptions populates the rate options in shipping_rates.html
  function createShippingOptions(rates) {
    // hide spinner
    document.querySelector('#spinner').style.display = "none";

    // set rates in session info
    let ratesJson = JSON.stringify(rates);
    sessionStorage.setItem('rates', ratesJson);
  
    // populate rate options in UI
    let options = document.querySelector('#shipping-options');
    for (let i = 0; i < rates.length; i++) {
      let rate = rates[i];
      let option = document.createElement('li');
      option.classList.add('list-item-shipping-option');
  
      let optionDiv = document.createElement('div');
      optionDiv.classList.add('div-shipping-option');
  
      let btnDiv = document.createElement('div');
      btnDiv.classList.add('div-shipping-option-radio-btn');
      let input = document.createElement('input');
      input.type = 'radio';
      input.classList.add('form-control');
      input.id = 'method' + i;
      input.name = rate.service_level.name;
      input.required = true;
      input.onchange = function() { updatePricing('#price' + i); };
      btnDiv.appendChild(input);
      
      let infoDiv = document.createElement('div');
      infoDiv.classList.add('div-shipping-option-info');
  
      let desc = document.createElement('p');
      desc.classList.add('p-shipping-option-info');
      desc.innerHTML = rate.provider + ' ' + rate.service_level.name;
      desc.id = 'service' + i;
  
      let price = document.createElement('p');
      price.classList.add('p-shipping-option-info');
      price.innerHTML = '$'+rate.price;
      price.id = 'price' + i;
  
      optionDiv.appendChild(btnDiv);
      infoDiv.appendChild(desc);
      infoDiv.appendChild(price);
      optionDiv.appendChild(infoDiv);
      option.appendChild(optionDiv);
      options.appendChild(option);
    }
    return
  }
  
  // PUT method implementation:
  async function putTextData(url = '', item = {}) {
    try {
      // Default options are marked with *
      const response = await fetch(url, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(item)
      });
      return response.json(); // parses JSON response into native JavaScript objects
    } catch (err) {
      console.log('postTextData err: ' + err);
      return err
    }
  }

  // POST method implementation:
  async function postData(url = '', item = {}) {
    try {
      // Default options are marked with *
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(item)
      });
      return response.json(); // parses JSON response into native JavaScript objects
    } catch (err) {
      console.log('postTextData err: ' + err);
      return err
    }
  }

function submitRateForm() {
  let formRaw = JSON.stringify($('#rate-form').serializeArray());
  let jsonArray = JSON.parse(formRaw);

  if (jsonArray.length == 0) {
      console.log("no option selected")
      return alert("Please select a shipping option.")
  }

  console.log(jsonArray);

  let rates = JSON.parse(sessionStorage.getItem('rates'));
  console.log(rates);

  // get customer for active order
  let custStr = sessionStorage.getItem('cust');
  if (custStr == "" || custStr == null) {
    // no active order; return to store page
    // use case: user visits shipping page URL directly,
    // bypassing order creation step
    console.log("no customer found")
    return window.location.replace(Endpoint + "/store")
    // return
  }
  
  let cust = JSON.parse(custStr);

  let rateName = jsonArray[0].name;
  let select = {};
  let found = false;

  for (let i = 0; i < rates.length; i++) {
      let rate = rates[i];
      if (rate.service_level.name == rateName) {
          select = {
              currency: rate.currency,
              price: rate.price,
              price_float: rate.price_float,
              provider: rate.provider,
              days: rate.days,
              service_level: {
                  name: rate.service_level.name,
                  token: rate.service_level.token,
                  terms: rate.service_level.terms,
              },
          };
          found = true;
      }
  }

  if (!found) {
      console.log("selected rate note found");
      return alert("Oops! Something went wrong. Please try again.")
  }

  let t = document.querySelector('#cart-total').innerHTML.split('$')[1];
  let total = parseFloat(t);

  let rateInfo = {
    user_id: cust.user_id,
    order_id: cust.order_id,
    rate: select,
    order_total: total,
  };

  // update pricing info
  let pricing = JSON.parse(sessionStorage.getItem('pricing'));
  pricing.shipping = rateInfo.rate.price_float;
  pricing.total += pricing.shipping
  sessionStorage.setItem('pricing', JSON.stringify(pricing));

  console.log(rateInfo)

  // reset form
  document.querySelector('#checkout-shipping-form').reset();

  // make db put call
  let postEndpoint = Endpoint + '/store/checkout/update_shipping';
  try {
    postData(postEndpoint, rateInfo)
    .then((response) => {
      console.log(response.message);
      console.log(response.body);
      // return alert(response.body)
      return window.location.replace(Endpoint + '/store/checkout/payment')
    })
    .catch((err) => {
      console.log('err: ' + err)
      return showErrModal(err);
    })
    
  } catch (error) {
    console.log('err: ' + error);
    return showErrModal(error);
  }
  
}
  
  /* MODAL FUNCTIONS */
    // Get the modal
    var modal = document.getElementById("myModal");
  
    // Get the <span> element that closes the modal
    var span = document.getElementsByClassName("close")[0];
  
    function showErrModal(err) {
      let content = document.querySelector('#modal-content');
      content.style.backgroundColor = '#D37A14';
      modal.style.display = "block";
      setTimeout(function() { modal.style.display = "none"; }, 8000);
    }
  
    function closeModal() {
      modal.style.display = "none";
    }
  
    // When the user clicks on <span> (x), close the modal
    span.onclick = function() {
      modal.style.display = "none";
    }
  
    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
      if (event.target == modal) {
      modal.style.display = "none";
      }
    }
  
  </script>
</body>
</html>
